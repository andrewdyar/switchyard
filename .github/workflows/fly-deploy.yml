name: Deploy to Fly.io

on:
  push:
    branches:
      - goods-customization

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max-old-space-size=8192"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --inline-builds

      - name: Build all packages
        run: yarn build

      - name: Build goods-backend (Medusa app)
        working-directory: apps/goods-backend
        run: npx medusa build

      - name: Prepare deployment package
        run: |
          # Create the deployment structure
          mkdir -p .fly-deploy/node_modules
          
          # Copy compiled backend
          cp -r apps/goods-backend/dist .fly-deploy/
          
          # Copy admin dashboard (client build)
          if [ -d "apps/goods-backend/.medusa/client" ]; then
            mkdir -p .fly-deploy/public/admin
            cp -r apps/goods-backend/.medusa/client/* .fly-deploy/public/admin/ 2>/dev/null || true
          fi
          
          # Copy public assets
          cp -r apps/goods-backend/public/* .fly-deploy/public/ 2>/dev/null || true
          
          # Create a standalone package.json without workspace references
          cat > .fly-deploy/package.json << 'PKGJSON'
          {
            "name": "goods-backend",
            "version": "1.0.0",
            "private": true,
            "scripts": {
              "start": "medusa start"
            },
            "dependencies": {
              "@medusajs/medusa": "2.12.1",
              "@medusajs/framework": "2.12.1",
              "@medusajs/cli": "2.12.1",
              "@medusajs/admin-sdk": "2.12.1"
            }
          }
          PKGJSON
          
          # Copy the workspace node_modules/@medusajs packages
          cp -r node_modules/@medusajs .fly-deploy/node_modules/ 2>/dev/null || true
          
          echo "=== Deployment package ==="
          ls -la .fly-deploy/
          ls -la .fly-deploy/node_modules/@medusajs/ 2>/dev/null | head -20 || echo "No @medusajs packages"

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --local-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
