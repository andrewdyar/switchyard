name: Deploy to Fly.io

on:
  push:
    branches:
      - goods-customization

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max-old-space-size=8192"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --inline-builds

      - name: Build all packages
        run: yarn build

      - name: Build goods-backend (Medusa app)
        working-directory: apps/goods-backend
        run: npx medusa build

      - name: Prepare deployment
        run: |
          # Create the deployment structure
          mkdir -p .fly-deploy
          
          # Copy compiled backend
          cp -r apps/goods-backend/dist .fly-deploy/
          
          # Copy medusa-config.js if in dist
          cp apps/goods-backend/dist/medusa-config.js .fly-deploy/ 2>/dev/null || true
          
          # Copy admin dashboard (client build)
          if [ -d "apps/goods-backend/.medusa/client" ]; then
            mkdir -p .fly-deploy/public/admin
            cp -r apps/goods-backend/.medusa/client/* .fly-deploy/public/admin/ 2>/dev/null || true
          fi
          
          # Copy public assets
          cp -r apps/goods-backend/public/* .fly-deploy/public/ 2>/dev/null || true
          
          # Copy package.json and create start script
          cp apps/goods-backend/package.json .fly-deploy/
          
          echo "=== Deployment package ==="
          find .fly-deploy -type f | head -50

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --local-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
